name: Frontend Accessibility Test

on:
  push:
    branches: [ "dev-fe","release", "main", "fe/ci-test2" ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-accessibility.yml'
  pull_request:
    branches: [ "dev-fe", "release","main", "fe/ci-test2" ]
    paths:
      - 'frontend/**'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'í…ŒìŠ¤íŠ¸ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - accessibility-only
        - performance-only

env:
  FE_DIR: frontend
  DEPLOY_BUCKET_NAME: ${{ secrets.FE_DEPLOY_BUCKET_NAME }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  REPORT_TIMESTAMP: ${{ github.run_number }}-${{ github.sha }}
  LIGHTHOUSE_SERVER_URL: ${{ vars.LIGHTHOUSE_SERVER_URL }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      test_type: ${{ steps.determine-test.outputs.test_type }}
    steps:
    - name: Determine test type
      id: determine-test
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          case "${{ github.event.inputs.test_type }}" in
            "full"|"accessibility-only"|"performance-only")
              echo "test_type=${{ github.event.inputs.test_type }}" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "âš ï¸ Invalid test_type input, defaulting to 'full'"
              echo "test_type=full" >> $GITHUB_OUTPUT
              ;;
          esac
        else
          echo "test_type=full" >> $GITHUB_OUTPUT
        fi

  axe-accessibility-testing:
    needs: setup
    if: needs.setup.outputs.test_type == 'full' || needs.setup.outputs.test_type == 'accessibility-only'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'yarn'
        cache-dependency-path: ${{ env.FE_DIR }}/yarn.lock

    - name: Install dependencies
      working-directory: ${{ env.FE_DIR }}
      run: yarn install --frozen-lockfile

    - name: Install accessibility testing dependencies
      working-directory: ${{ env.FE_DIR }}
      run: |
        echo "ğŸ“¦ Installing accessibility testing packages..."
        yarn add -D @playwright/test@^1.48.0 @axe-core/playwright@^4.10.2 playwright-html-reporter@^0.1.11
        yarn playwright install chromium

    - name: Inject accessibility test file
      working-directory: ${{ env.FE_DIR }}
      run: |
        echo "ğŸ“ Injecting accessibility test configuration..."
        cat << 'ACCESSIBILITY_TEST_EOF' > accessibility.test.js
        ${{ vars.ACCESSIBILITY_TEST_JS }}
        ACCESSIBILITY_TEST_EOF
        echo "âœ… Accessibility test file created"

    - name: Inject playwright config file
      working-directory: ${{ env.FE_DIR }}
      run: |
        echo "ğŸ“ Injecting playwright configuration..."
        cat << 'PLAYWRIGHT_CONFIG_EOF' > playwright.config.accessibility.js
        ${{ vars.PLAYWRIGHT_CONFIG_ACCESSIBILITY_JS }}
        PLAYWRIGHT_CONFIG_EOF
        echo "âœ… Playwright config file created"

    - name: Build application
      working-directory: ${{ env.FE_DIR }}
      run: yarn build

    - name: Start development server
      working-directory: ${{ env.FE_DIR }}
      run: |
        echo "ğŸš€ Starting development server..."
        yarn preview --port 5173 --host &
        sleep 10
        
        for i in {1..10}; do
          if curl -f http://localhost:5173 > /dev/null 2>&1; then
            echo "âœ… Server is ready!"
            break
          fi
          echo "â³ Waiting for server... ($i/10)"
          sleep 3
        done

    - name: Run axe accessibility tests
      working-directory: ${{ env.FE_DIR }}
      env:
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_RUN_NUMBER: ${{ github.run_number }}
        CI: true
      run: |
        echo "ğŸ§ª Running axe accessibility tests..."
        mkdir -p screenshots accessibility-reports
        echo "ğŸš€ Running tests:"
        yarn playwright test --config=./playwright.config.accessibility.js --reporter=list
      continue-on-error: false

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_DEPLOY_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_DEPLOY_SECRET_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Upload axe reports to S3
      working-directory: ${{ env.FE_DIR }}
      run: |
        echo "ğŸ“‹ Uploading Axe reports to S3..."
        echo "ğŸ” Target bucket: s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/"
        if [ -d "accessibility-reports" ]; then
          aws s3 cp ./accessibility-reports/ s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/${{ env.REPORT_TIMESTAMP }}/axe-reports/ --recursive
          aws s3 cp ./accessibility-reports/ s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/latest/axe-reports/ --recursive
        fi
        if [ -d "screenshots" ]; then
          aws s3 cp ./screenshots/ s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/${{ env.REPORT_TIMESTAMP }}/screenshots/ --recursive
          aws s3 cp ./screenshots/ s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/latest/screenshots/ --recursive
        fi

  lighthouse-ci-testing:
    needs: setup
    if: needs.setup.outputs.test_type == 'full' || needs.setup.outputs.test_type == 'performance-only'
    runs-on: ubuntu-latest
    timeout-minutes: 35
    strategy:
      matrix:
        device: [desktop, mobile]
      fail-fast: false

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'yarn'
        cache-dependency-path: ${{ env.FE_DIR }}/yarn.lock

    - name: Install dependencies
      working-directory: ${{ env.FE_DIR }}
      run: yarn install --frozen-lockfile

    - name: Install Lighthouse CI
      working-directory: ${{ env.FE_DIR }}
      run: |
        echo "ğŸ“¦ Installing Lighthouse CI..."
        yarn add -D @lhci/cli@^0.15.0

    - name: Inject Lighthouse configuration
      working-directory: ${{ env.FE_DIR }}
      env:
        LIGHTHOUSERC_DESKTOP_JSON: ${{ vars.LIGHTHOUSERC_DESKTOP_JSON }}
        LIGHTHOUSERC_MOBILE_JSON: ${{ vars.LIGHTHOUSERC_MOBILE_JSON }}
      run: |
        echo "ğŸ“ Injecting ${{ matrix.device }} Lighthouse CI configuration..."
        
        if [ "${{ matrix.device }}" == "desktop" ]; then
          echo "$LIGHTHOUSERC_DESKTOP_JSON" > .lighthouserc.desktop.json
        else
          echo "$LIGHTHOUSERC_MOBILE_JSON" > .lighthouserc.mobile.json
        fi
        
        echo "âœ… ${{ matrix.device }} Lighthouse configuration injected successfully"

    - name: Build application
      working-directory: ${{ env.FE_DIR }}
      run: yarn build

    - name: Start production server
      working-directory: ${{ env.FE_DIR }}
      run: |
        echo "ğŸš€ Starting production server for ${{ matrix.device }} testing..."
        yarn preview --port 5173 --host &
        sleep 15
        
        for i in {1..10}; do
          if curl -f http://localhost:5173 > /dev/null 2>&1; then
            echo "âœ… Server is ready!"
            break
          fi
          echo "â³ Waiting for server... ($i/10)"
          sleep 3
        done

    - name: Test Lighthouse server connection
      id: lighthouse-server-test
      run: |
        echo "ğŸ” Testing Lighthouse server connection..."
        if curl -f "${{ env.LIGHTHOUSE_SERVER_URL }}/health" > /dev/null 2>&1; then
          echo "âœ… Lighthouse server is available"
          echo "server_available=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Lighthouse server is not available, will run locally only"
          echo "server_available=false" >> $GITHUB_OUTPUT
        fi

    - name: Run Lighthouse CI (${{ matrix.device }}) with server upload
      if: steps.lighthouse-server-test.outputs.server_available == 'true'
      working-directory: ${{ env.FE_DIR }}
      env:
        LHCI_GITHUB_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN  }}
      run: |
        echo "${{ matrix.device == 'desktop' && 'ğŸ–¥ï¸' || 'ğŸ“±' }} Running ${{ matrix.device }} Lighthouse CI with server upload..."
        yarn lhci autorun --config=.lighthouserc.${{ matrix.device }}.json
      continue-on-error: true

    - name: Run Lighthouse CI (${{ matrix.device }}) - local only
      if: steps.lighthouse-server-test.outputs.server_available == 'false'
      working-directory: ${{ env.FE_DIR }}
      env:
        LHCI_GITHUB_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN  }}
        LIGHTHOUSERC_DESKTOP_LOCAL_JSON: ${{ vars.LIGHTHOUSERC_DESKTOP_LOCAL_JSON }}
        LIGHTHOUSERC_MOBILE_LOCAL_JSON: ${{ vars.LIGHTHOUSERC_MOBILE_LOCAL_JSON }}
      run: |
        echo "${{ matrix.device == 'desktop' && 'ğŸ–¥ï¸' || 'ğŸ“±' }} Running ${{ matrix.device }} Lighthouse CI (local only)..."
        
        # ë¡œì»¬ ì „ìš© ì„¤ì • ì£¼ì…
        if [ "${{ matrix.device }}" == "desktop" ]; then
          echo "$LIGHTHOUSERC_DESKTOP_LOCAL_JSON" > .lighthouserc.desktop.local.json
          yarn lhci autorun --config=.lighthouserc.desktop.local.json
        else
          echo "$LIGHTHOUSERC_MOBILE_LOCAL_JSON" > .lighthouserc.mobile.local.json
          yarn lhci autorun --config=.lighthouserc.mobile.local.json
        fi
      continue-on-error: true

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_DEPLOY_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_DEPLOY_SECRET_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Upload Lighthouse reports to S3
      working-directory: ${{ env.FE_DIR }}
      run: |
        echo "ğŸš€ Uploading ${{ matrix.device }} Lighthouse reports to S3..."
        echo "ğŸ” Target bucket: s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/"
        
        # LHCI ì„œë²„ ì—…ë¡œë“œëœ ë¦¬í¬íŠ¸
        if [ -d ".lighthouseci" ]; then
          aws s3 cp ./.lighthouseci/ s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/${{ env.REPORT_TIMESTAMP }}/lighthouse-${{ matrix.device }}/ --recursive
          aws s3 cp ./.lighthouseci/ s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/latest/lighthouse-${{ matrix.device }}/ --recursive
        fi
        
        # ë¡œì»¬ ì „ìš© ë¦¬í¬íŠ¸
        if [ -d "lighthouse-reports-${{ matrix.device }}" ]; then
          aws s3 cp ./lighthouse-reports-${{ matrix.device }}/ s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/${{ env.REPORT_TIMESTAMP }}/lighthouse-${{ matrix.device }}-local/ --recursive
          aws s3 cp ./lighthouse-reports-${{ matrix.device }}/ s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/latest/lighthouse-${{ matrix.device }}-local/ --recursive
        fi

  generate-combined-report:
    needs: [axe-accessibility-testing, lighthouse-ci-testing]
    if: always() && (needs.axe-accessibility-testing.result != 'cancelled' || needs.lighthouse-ci-testing.result != 'cancelled')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_DEPLOY_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_DEPLOY_SECRET_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Generate combined report
      env:
        AXE_RESULT: ${{ needs.axe-accessibility-testing.result }}
        LIGHTHOUSE_RESULT: ${{ needs.lighthouse-ci-testing.result }}
        REPORT_TIMESTAMP: ${{ env.REPORT_TIMESTAMP }}
        DEPLOY_BUCKET_NAME: ${{ secrets.FE_DEPLOY_BUCKET_NAME }}
      run: |
        echo "ğŸ“Š Generating combined accessibility & performance report..."
        mkdir -p combined-reports
        

        cat << 'GENERATE_REPORT_EOF' > generate-combined-report.js
        ${{ vars.GENERATE_COMBINED_REPORT_JS }}
        GENERATE_REPORT_EOF

        node ./generate-combined-report.js

    - name: Upload combined reports to S3
      run: |
        echo "ğŸ“¤ Uploading reports to S3..."
        echo "ğŸ” Target bucket: s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/"
        
        aws s3 sync ./combined-reports/ s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/${{ env.REPORT_TIMESTAMP }}/ 
        aws s3 sync ./combined-reports/ s3://${{ env.DEPLOY_BUCKET_NAME }}/accessibility-reports/latest/ 
        
        echo "âœ… ë³´ê³ ì„œ ì—…ë¡œë“œ ì™„ë£Œ!"
        echo "ğŸ“‹ ìµœì‹  ë³´ê³ ì„œ: https://${{ env.DEPLOY_BUCKET_NAME }}.s3.${{ env.AWS_REGION }}.amazonaws.com/accessibility-reports/latest/index.html"
        echo "ğŸ• íƒ€ì„ìŠ¤íƒ¬í”„ ë³´ê³ ì„œ: https://${{ env.DEPLOY_BUCKET_NAME }}.s3.${{ env.AWS_REGION }}.amazonaws.com/accessibility-reports/${{ env.REPORT_TIMESTAMP }}/index.html"

    - name: Notify Discord on Success
      if: success()
      uses: tsickert/discord-webhook@v7.0.0
      with:
        webhook-url: ${{ secrets.NOTIFICATION_WEBHOOK_URI }}
        embed-title: "âœ… ì ‘ê·¼ì„± & ì„±ëŠ¥ ê²€ì‚¬ ì™„ë£Œ!"
        embed-description: |
          **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
          **ì»¤ë°‹:** `${{ github.event.head_commit.message }}`
          **ì‘ì„±ì:** `${{ github.event.head_commit.author.name }}`
          
          ğŸ“Š **ë³´ê³ ì„œ:**
          â€¢ [ğŸ“‹ ìµœì‹  í†µí•© ë³´ê³ ì„œ](https://${{ env.DEPLOY_BUCKET_NAME }}.s3.${{ env.AWS_REGION }}.amazonaws.com/accessibility-reports/latest/index.html)
          â€¢ [ğŸ• íƒ€ì„ìŠ¤íƒ¬í”„ ë³´ê³ ì„œ](https://${{ env.DEPLOY_BUCKET_NAME }}.s3.${{ env.AWS_REGION }}.amazonaws.com/accessibility-reports/${{ env.REPORT_TIMESTAMP }}/index.html)
          â€¢ [ğŸŒ Lighthouse ì„œë²„ ëŒ€ì‹œë³´ë“œ](${{ env.LIGHTHOUSE_SERVER_URL }})
          â€¢ [ğŸŒ axe ì ‘ê·¼ì„± ê²€ì‚¬ ë³´ê³ ì„œ](https://${{ env.DEPLOY_BUCKET_NAME }}.s3.${{ env.AWS_REGION }}.amazonaws.com/accessibility-reports/latest/axe-reports/accessibility-report.html)
          
          ğŸ” **í…ŒìŠ¤íŠ¸ ìƒì„¸:**
          â€¢ Axe ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸: ${{ needs.axe-accessibility-testing.result }}
          â€¢ Lighthouse ì¢…í•© í…ŒìŠ¤íŠ¸: ${{ needs.lighthouse-ci-testing.result }}
          
          ğŸ“‹ **ê²€ì‚¬ëœ í˜ì´ì§€:**
          â€¢ ğŸ  í™ˆí˜ì´ì§€, ğŸ” ë¡œê·¸ì¸, ğŸ“Š ëŒ€ì‹œë³´ë“œ
          â€¢ ğŸ“ ë…¸íŠ¸, â° íƒ€ì´ë¨¸, ğŸ“š ìŠ¤í„°ë””
          
          ğŸ”— **ë§í¬:**
          â€¢ [ì»¤ë°‹ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
        embed-color: 3066993

    - name: Notify Discord on Failure
      if: failure()
      uses: tsickert/discord-webhook@v7.0.0
      with:
        webhook-url: ${{ secrets.NOTIFICATION_WEBHOOK_URI }}
        embed-title: "âŒ ì ‘ê·¼ì„± & ì„±ëŠ¥ ê²€ì‚¬ ì‹¤íŒ¨!"
        embed-description: |
          **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
          **ì»¤ë°‹:** `${{ github.event.head_commit.message }}`
          **ì‘ì„±ì:** `${{ github.event.head_commit.author.name }}`
          
          ğŸ” **í…ŒìŠ¤íŠ¸ ìƒíƒœ:**
          â€¢ Axe ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸: ${{ needs.axe-accessibility-testing.result }}
          â€¢ Lighthouse ì¢…í•© í…ŒìŠ¤íŠ¸: ${{ needs.lighthouse-ci-testing.result }}
          
          ğŸ”— **ë§í¬:**
          â€¢ [ì»¤ë°‹ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          â€¢ [Lighthouse ì„œë²„](${{ env.LIGHTHOUSE_SERVER_URL }})
        embed-color: 15158332 